(function(){"use strict";var w=function(A,c,S,b,_){if(c=c!==void 0?c:!0,S=S!==void 0?S:!0,b=b||Math.pow(2,-52),_=1e-64/b,!A)throw new TypeError("Matrix a is not defined");var n=A[0].length,h=A.length;if(h<n)throw new TypeError("Invalid matrix: m < n");var r,f,o,i,g,M,l,s,t,a,y,m,d;s=0,y=0;var u=[],e=[],q=[],p=c==="f"?h:n;for(r=0;r<h;r++)e[r]=new Array(p).fill(0);for(r=0;r<n;r++)q[r]=new Array(n).fill(0);var v=new Array(n).fill(0);for(r=0;r<h;r++)for(f=0;f<n;f++)e[r][f]=A[r][f];for(r=0;r<n;r++){for(u[r]=s,a=0,i=r+1,f=r;f<h;f++)a+=Math.pow(e[f][r],2);if(a<_)s=0;else for(l=e[r][r],s=l<0?Math.sqrt(a):-Math.sqrt(a),t=l*s-a,e[r][r]=l-s,f=i;f<n;f++){for(a=0,o=r;o<h;o++)a+=e[o][r]*e[o][f];for(l=a/t,o=r;o<h;o++)e[o][f]=e[o][f]+l*e[o][r]}for(v[r]=s,a=0,f=i;f<n;f++)a+=Math.pow(e[r][f],2);if(a<_)s=0;else{for(l=e[r][r+1],s=l<0?Math.sqrt(a):-Math.sqrt(a),t=l*s-a,e[r][r+1]=l-s,f=i;f<n;f++)u[f]=e[r][f]/t;for(f=i;f<h;f++){for(a=0,o=i;o<n;o++)a+=e[f][o]*e[r][o];for(o=i;o<n;o++)e[f][o]=e[f][o]+a*u[o]}}m=Math.abs(v[r])+Math.abs(u[r]),m>y&&(y=m)}if(S)for(r=n-1;r>=0;r--){if(s!==0){for(t=e[r][r+1]*s,f=i;f<n;f++)q[f][r]=e[r][f]/t;for(f=i;f<n;f++){for(a=0,o=i;o<n;o++)a+=e[r][o]*q[o][f];for(o=i;o<n;o++)q[o][f]=q[o][f]+a*q[o][r]}}for(f=i;f<n;f++)q[r][f]=0,q[f][r]=0;q[r][r]=1,s=u[r],i=r}if(c){if(c==="f")for(r=n;r<h;r++){for(f=n;f<h;f++)e[r][f]=0;e[r][r]=1}for(r=n-1;r>=0;r--){for(i=r+1,s=v[r],f=i;f<p;f++)e[r][f]=0;if(s!==0){for(t=e[r][r]*s,f=i;f<p;f++){for(a=0,o=i;o<h;o++)a+=e[o][r]*e[o][f];for(l=a/t,o=r;o<h;o++)e[o][f]=e[o][f]+l*e[o][r]}for(f=r;f<h;f++)e[f][r]=e[f][r]/s}else for(f=r;f<h;f++)e[f][r]=0;e[r][r]=e[r][r]+1}}b=b*y;var k;for(o=n-1;o>=0;o--)for(var j=0;j<50;j++){for(k=!1,i=o;i>=0;i--){if(Math.abs(u[i])<=b){k=!0;break}if(Math.abs(v[i-1])<=b)break}if(!k){for(M=0,a=1,g=i-1,r=i;r<o+1&&(l=a*u[r],u[r]=M*u[r],!(Math.abs(l)<=b));r++)if(s=v[r],v[r]=Math.sqrt(l*l+s*s),t=v[r],M=s/t,a=-l/t,c)for(f=0;f<h;f++)m=e[f][g],d=e[f][r],e[f][g]=m*M+d*a,e[f][r]=-m*a+d*M}if(d=v[o],i===o){if(d<0&&(v[o]=-d,S))for(f=0;f<n;f++)q[f][o]=-q[f][o];break}for(y=v[i],m=v[o-1],s=u[o-1],t=u[o],l=((m-d)*(m+d)+(s-t)*(s+t))/(2*t*m),s=Math.sqrt(l*l+1),l=((y-d)*(y+d)+t*(m/(l<0?l-s:l+s)-t))/y,M=1,a=1,r=i+1;r<o+1;r++){if(s=u[r],m=v[r],t=a*s,s=M*s,d=Math.sqrt(l*l+t*t),u[r-1]=d,M=l/d,a=t/d,l=y*M+s*a,s=-y*a+s*M,t=m*a,m=m*M,S)for(f=0;f<n;f++)y=q[f][r-1],d=q[f][r],q[f][r-1]=y*M+d*a,q[f][r]=-y*a+d*M;if(d=Math.sqrt(l*l+t*t),v[r-1]=d,M=l/d,a=t/d,l=M*s+a*m,y=-a*s+M*m,c)for(f=0;f<h;f++)m=e[f][r-1],d=e[f][r],e[f][r-1]=m*M+d*a,e[f][r]=-m*a+d*M}u[i]=0,u[o]=l,v[o]=y}for(r=0;r<n;r++)v[r]<b&&(v[r]=0);return{u:e,q:v,v:q}};function U(V,A,c){let S=new Array(A);for(let t=0;t<A;t++)S[t]=Array.from(V.slice(t*c,(t+1)*c));let b=!1;if(A<c){const t=new Array(c);for(let a=0;a<c;a++){t[a]=new Array(A);for(let y=0;y<A;y++)t[a][y]=S[y][a]}S=t,b=!0}const{u:_,q:n,v:h}=w(S),r=n.map((t,a)=>a).sort((t,a)=>n[a]-n[t]),f=r.map(t=>n[t]),o=_.map(t=>r.map(a=>t[a])),i=h.map(t=>r.map(a=>t[a]));let g,M,l,s=f.length;if(b){g=i.flat(),M=Array.from(f),l=new Float32Array(s*c);for(let t=0;t<s;t++)for(let a=0;a<c;a++)l[t*c+a]=o[a][t]}else{g=o.flat(),M=Array.from(f),l=new Float32Array(s*c);for(let t=0;t<s;t++)for(let a=0;a<c;a++)l[t*c+a]=i[a][t]}return{U_data:g,S_data:M,Vt_data:l,m:A,n:c,r:s}}self.onmessage=function(V){const{channels:A,width:c,height:S,isColor:b}=V.data,_={};if(b){const n=["1","2","3"];A.forEach((h,r)=>{const f=U(h,S,c);_[`U${n[r]}`]=f.U_data,_[`S${n[r]}`]=f.S_data,_[`Vt${n[r]}`]=f.Vt_data})}else{const n=U(A[0],S,c);_.U=n.U_data,_.S=n.S_data,_.Vt=n.Vt_data}self.postMessage(_)}})();
